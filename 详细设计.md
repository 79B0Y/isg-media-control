# iSG Media Controller 产品详细设计文档

## 1. 产品简介

**产品名称**： iSG Media Controller
**运行环境**： Termux Proot Ubuntu
**目标**：提供一个统一的多媒体控制应用层，可控制 iSG 内所有流媒体 App 和本地媒体库，并通过 MQTT 和 REST API 与 Home Assistant 零隔合。

## 2. 主要功能

### 2.1 操作控制

* **基础操作**：播放、暂停、上一首、下一首、调节、跳播
* **声音控制**：音量调节、静音切换
* **交互方式**：MQTT 指令、REST API

### 2.2 媒体源管理

* **选择 iSG 内的媒体库**：本地文件、Spotify 播放列表、YouTube 播放列表
* **跨平台操作**：一致化 API ，支持 Spotify / YouTube / Chromecast / 蓝牙 / MPV / MPD

### 2.3 App 控制和登录

* **前台流媒体服务检测**：自动获取当前活跃 App
* **账号登录自助**：优先使用深链接/OAuth，无接口时通过 ADB+uiautomator 实现并记录为 YAML 定义的宏

### 2.4 播放意图与智能推荐

* **盲搜/意图播歌**：使用 OpenAI/Gemini API 识别用户意图，返回适合的播放列表
* **自动回退**：找不到或无法播放时自动替换下一首
* **候选缓存**：同一意图复用上一次的候选结果

### 2.5 Home Assistant 集成

* **MQTT Discovery**：自动注册 `media_player.isg_media`
* **支持的指令**：play、pause、next、prev、volume\_set、seek、shuffle\_set、repeat\_set、play\_media、select\_source
* **状态上报**：当前平台、曲目、进度、音量、播放状态、封面等

### 2.6 队列与会话管理

* **跨平台队列**：统一播放队列接口
* **会话恢复**：中断恢复到上一次播放状态
* **高级模式**：睡眠定时、儿童模式（过滤不适合内容）

### 2.7 安全与运维

* **安全**：Token 鉴权、本地加密存储敏感信息、请求限流
* **运维**：健康检查 `/healthz`、Prometheus `/metrics`、结构化日志、ADB 自动重连

## 3. 技术架构

```text
isg-media-controller/
├─ core/                # 核心调度与队列管理
├─ adapters/            # 各媒体源适配器
├─ android/             # ADB 与 UI 宏控制
├─ api/                 # REST API 层
├─ mqtt/                # MQTT 与 HA 集成
├─ providers/           # LLM 接口与推荐逻辑
├─ config/              # 配置文件
└─ main.py               # 启动入口
```

## 4. 关键技术点

* **深链/Intent 优先**：减少对 UI 自动化的依赖
* **媒体会话控制**：优先 `cmd media_session`，兜底使用 `input keyevent`
* **UI 宏模板**：YAML 描述点击、输入、等待等步骤
* **多通道路由与回退**：优先级、超时、自动切换
* **安全机制**：加密、限流、防误触保护模式

## 5. API 设计

### 5.1 REST API（端口 8010）

* `POST /api/v1/play` { platform, uri|query, library, shuffle, device }
* `POST /api/v1/pause`
* `POST /api/v1/next`
* `POST /api/v1/prev`
* `POST /api/v1/search` { query, intent, limit }
* `POST /api/v1/login/:platform`
* `POST /api/v1/queue`
* `POST /api/v1/library/scan`
* `GET /api/v1/state`
* `GET /healthz`
* `GET /metrics`

### 5.2 MQTT Topics

* **命令**：`isg/media/command`
* **状态**：`isg/media/state`
* **属性**：`isg/media/attr`
* **事件**：`isg/media/event`

## 6. 配置示例

```yaml
adb:
  host: 127.0.0.1
  port: 5555
mqtt:
  broker: 127.0.0.1
  port: 1883
rest:
  host: 0.0.0.0
  port: 8010
llm:
  provider: openai
  model: gpt-4.1-mini
library:
  local_paths:
    - /data/music
```

## 7. 实现里程碑

* **M1**：ADB 控制基础 + REST/MQTT 基本功能
* **M2**：Spotify/YouTube 深链播放 + 登录宏
* **M3**：媒体库/队列/会话恢复
* **M4**：HA 深度集成（封面/进度等）
* **M5**：Auto DJ 意图播歌
* **M6**：多通道扩展（Cast/蓝牙）+ 儿童模式 + 高级运维

## 8. 风险与应对

* **App UI 变化**：以深链/Intent 为主，宏兜底，宏可热更新
* **ADB 连接不稳定**：自动重连与命令重试
* **版权/地区限制**：平台回退机制
* **安全风险**：本地加密与最小权限策略

---

**备注**：此设计文档覆盖了功能需求、技术架构、API 规范、配置示例、里程碑与风险控制，适合直接作为开发与实施的蓝本。
